name: Deploy via Tailscale (reusable)

'on':
  workflow_call:
    inputs:
      build_cmd:
        description: Optional build step executed on the runner before deploy
        required: false
        type: string
        default: ""
      remote_repo_path:
        description: Path to the repo on the server (e.g. ~/mmc-infrastructure)
        required: true
        type: string
      remote_branch:
        description: Git branch to deploy on the server
        required: false
        type: string
        default: production
      git_clean_exclude:
        description: Optional path to exclude from git clean
        required: false
        type: string
        default: ""
      deploy_cmd:
        description: Shell commands executed on the server after updating the repo
        required: true
        type: string
      tailscale_tags:
        description: Optional comma-separated Tailscale tags (defaults to vars.TS_TAGS or tag:ci)
        required: false
        type: string
        default: ""
    secrets:
      TS_OAUTH_CLIENT_ID:
        required: true
      TS_OAUTH_SECRET:
        required: true
      DEPLOY_HOST:
        required: true
      DEPLOY_USER:
        required: true
      DEPLOY_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      TS_OAUTH_CLIENT_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
      TS_OAUTH_SECRET: ${{ secrets.TS_OAUTH_SECRET }}
      ORG_TS_TAGS: ${{ vars.TS_TAGS }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          # In a reusable workflow, actions/checkout would otherwise check out the workflow repo.
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          fetch-depth: 1

      - name: Build
        if: ${{ inputs.build_cmd != '' }}
        run: |
          set -euo pipefail
          ${{ inputs.build_cmd }}

      - name: Validate deploy secrets
        run: |
          set -euo pipefail
          [ -n "$DEPLOY_HOST" ] || { echo "::error::DEPLOY_HOST secret is missing"; exit 1; }
          [ -n "$DEPLOY_USER" ] || { echo "::error::DEPLOY_USER secret is missing"; exit 1; }
          [ -n "$DEPLOY_SSH_KEY" ] || { echo "::error::DEPLOY_SSH_KEY secret is missing"; exit 1; }
          [ -n "$TS_OAUTH_CLIENT_ID" ] || { echo "::error::TS_OAUTH_CLIENT_ID secret is missing"; exit 1; }
          [ -n "$TS_OAUTH_SECRET" ] || { echo "::error::TS_OAUTH_SECRET secret is missing"; exit 1; }

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: ${{ inputs.tailscale_tags != '' && inputs.tailscale_tags || (vars.TS_TAGS != '' && vars.TS_TAGS || 'tag:ci') }}
          ping: ${{ secrets.DEPLOY_HOST }}

      - name: Deploy on server
        run: |
          set -euo pipefail

          install -m 700 -d ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          if ! command -v rsync >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y rsync
          fi

          # Expand ~/... to an absolute path on the server.
          remote_home=$(ssh "$DEPLOY_USER@$DEPLOY_HOST" 'printf %s "$HOME"')
          remote_path='${{ inputs.remote_repo_path }}'
          if [[ "$remote_path" == "~/"* ]]; then
            remote_path="$remote_home/${remote_path#~/}"
          elif [[ "$remote_path" == /* ]]; then
            :
          else
            remote_path="$remote_home/$remote_path"
          fi

          ssh "$DEPLOY_USER@$DEPLOY_HOST" "REMOTE_PATH='$remote_path' bash -seuo pipefail" <<'EOF'
          set -euo pipefail
          mkdir -p "$REMOTE_PATH"
          EOF

          # Sync repository contents to server (server does not need GitHub deploy keys).
          excludes=("--exclude=.git/")
          exclude_raw='${{ inputs.git_clean_exclude }}'
          if [ -n "$exclude_raw" ]; then
            while IFS= read -r line; do
              # trim leading/trailing whitespace
              line="${line#"${line%%[![:space:]]*}"}"
              line="${line%"${line##*[![:space:]]}"}"
              [ -n "$line" ] || continue
              excludes+=("--exclude=$line")
            done <<< "$exclude_raw"
          fi

          # Avoid preserving owner/group/perms; some paths on the server may be root-owned.
          # Keep symlinks and file mtimes; omit dir mtimes to reduce permission-related failures.
          rsync -rltz --delete --omit-dir-times "${excludes[@]}" ./ "$DEPLOY_USER@$DEPLOY_HOST:$remote_path/"

          ssh "$DEPLOY_USER@$DEPLOY_HOST" "REMOTE_PATH='$remote_path' GITHUB_SHA='${{ github.sha }}' GITHUB_REPOSITORY='${{ github.repository }}' bash -seuo pipefail" <<'EOF'
          set -euo pipefail
          cd "$REMOTE_PATH"
          ${{ inputs.deploy_cmd }}
          EOF
